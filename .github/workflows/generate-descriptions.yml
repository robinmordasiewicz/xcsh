name: Generate LLM Descriptions

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Ollama model to use'
        required: false
        default: 'deepseek-r1:1.5b'
  workflow_call:
    inputs:
      model:
        description: 'Ollama model to use'
        required: false
        type: string
        default: 'deepseek-r1:1.5b'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama Server
        run: |
          ollama serve &
          # Wait for server to start
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "Ollama server is ready"
              break
            fi
            echo "Waiting for Ollama server... ($i/30)"
            sleep 2
          done

      - name: Pull Model
        run: |
          echo "Pulling model ${{ inputs.model || 'deepseek-r1:1.5b' }}..."
          ollama pull "${{ inputs.model || 'deepseek-r1:1.5b' }}"

      - name: Verify Model
        run: |
          ollama list

      - name: Generate LLM Descriptions
        run: |
          go run scripts/generate-llm-descriptions.go \
            -specs docs/specifications/api \
            -output pkg/types/descriptions_generated.json \
            -model "${{ inputs.model || 'deepseek-r1:1.5b' }}" \
            -ollama-url http://localhost:11434 \
            -v

      - name: Show Generated Descriptions
        run: |
          echo "=== Generated Descriptions ==="
          cat pkg/types/descriptions_generated.json | jq '.descriptions | to_entries | .[0:5]'
          echo ""
          echo "Total descriptions: $(cat pkg/types/descriptions_generated.json | jq '.descriptions | length')"

      - name: Regenerate Schemas with LLM Descriptions
        run: |
          go run scripts/generate-schemas.go -v -update-resources -use-llm-descriptions

      - name: Verify Build
        run: |
          make build
          make test-unit

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: regenerate resource descriptions with LLM'
          title: 'chore: Update resource descriptions (LLM-generated)'
          body: |
            This PR updates resource descriptions using LLM-generated corrections.

            **Model used**: ${{ inputs.model || 'deepseek-r1:1.5b' }}

            ## Changes
            - Fixed grammatical errors in resource descriptions
            - Improved clarity and consistency across all resources

            ## Verification
            - [x] Build passes
            - [x] Unit tests pass
            - [x] `f5xcctl --spec` shows improved descriptions

            Auto-generated by GitHub Actions workflow.
          branch: chore/llm-descriptions
          delete-branch: true
          labels: |
            documentation
            automated
