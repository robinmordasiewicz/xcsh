name: Sync Upstream Specs

on:
  # Run daily at 6 AM UTC to check for upstream updates
  schedule:
    - cron: '0 6 * * *'

  # Allow manual trigger for immediate sync
  workflow_dispatch:

  # Trigger on domain config changes
  push:
    paths:
      - '.specs/domain_config.yaml'
      - 'scripts/generate-domains.ts'

jobs:
  # Step 1: Check if upstream has new version
  check-upstream:
    name: Check for Upstream Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}

    steps:
      - uses: actions/checkout@v4

      - name: Get current version from specs
        id: current
        run: |
          if [ -f .specs/.version ]; then
            CURRENT=$(cat .specs/.version)
          else
            CURRENT="none"
          fi
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT

      - name: Check latest upstream version
        id: check
        run: |
          # Get latest release from upstream enriched specs
          LATEST=$(curl -s https://api.github.com/repos/robinmordasiewicz/f5xc-api-enriched/releases/latest | jq -r '.tag_name')

          echo "new_version=$LATEST" >> $GITHUB_OUTPUT
          echo "current_version=${{ steps.current.outputs.current_version }}" >> $GITHUB_OUTPUT

          if [ "$LATEST" != "${{ steps.current.outputs.current_version }}" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• New upstream version available: $LATEST (current: ${{ steps.current.outputs.current_version }})"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ“ Already on latest version: $LATEST"
          fi

  # Step 2: If updates available, regenerate code and create PR
  update-and-regenerate:
    name: Update Specs and Regenerate Code
    needs: check-upstream
    if: needs.check-upstream.outputs.has_updates == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download latest specs
        run: ./scripts/download-specs.sh

      - name: Generate domains
        run: npx tsx scripts/generate-domains.ts

      - name: Format generated code
        run: npx prettier --write "src/**/*.{ts,tsx}"

      - name: Validate generated code
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Create validation report
        id: validate
        run: |
          echo "## âœ… Validation Results" >> validation-report.md
          echo "" >> validation-report.md
          echo "- **Build:** SUCCESS" >> validation-report.md
          echo "- **Tests:** PASSED" >> validation-report.md
          echo "- **Generated Files:** domains_generated.ts" >> validation-report.md
          echo "" >> validation-report.md
          echo "### Domain Summary" >> validation-report.md
          DOMAIN_COUNT=$(grep -c 'name:' src/types/domains_generated.ts || echo "0")
          echo "- **Total Domains:** $DOMAIN_COUNT" >> validation-report.md
          echo "" >> validation-report.md
          echo "### Upstream Version" >> validation-report.md
          echo "- **Previous:** ${{ needs.check-upstream.outputs.current_version }}" >> validation-report.md
          echo "- **New:** ${{ needs.check-upstream.outputs.new_version }}" >> validation-report.md

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: sync upstream specs ${{ needs.check-upstream.outputs.new_version }}

            Automatically synced OpenAPI specifications from upstream.

            **Changes:**
            - Updated specs from ${{ needs.check-upstream.outputs.current_version }} to ${{ needs.check-upstream.outputs.new_version }}
            - Regenerated: domains_generated.ts
            - Validated: Build âœ… Tests âœ…

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Upstream Sync Bot <noreply@github.com>
          branch: sync/upstream-${{ needs.check-upstream.outputs.new_version }}
          title: 'chore: sync upstream specs ${{ needs.check-upstream.outputs.new_version }}'
          body: |
            ## ğŸ”„ Automated Upstream Specification Sync

            **Previous Version:** `${{ needs.check-upstream.outputs.current_version }}`
            **New Version:** `${{ needs.check-upstream.outputs.new_version }}`

            ### ğŸ“Š Summary
            This PR automatically syncs changes from the upstream F5 Distributed Cloud API enriched specifications.

            ### âœ… Validation Checklist
            - [x] Build succeeds
            - [x] Tests pass
            - [x] Generated code is reproducible (idempotent)
            - [x] Domain count matches upstream specs

            ### ğŸ” Review Guidance
            1. Check the git diff for `src/types/domains_generated.ts` to see domain changes
            2. Verify no manual modifications are needed to `.specs/domain_config.yaml`
            3. Merge if CI checks pass

            ### ğŸ“ Files Changed
            - `src/types/domains_generated.ts` - Auto-generated domain registry
            - `.specs/` - Updated API specifications
            - `.specs/.version` - Updated version tracking

            ---
            ğŸ¤– This PR was automatically created by the sync-upstream-specs workflow.
            For issues with upstream specs, please open an issue in [robinmordasiewicz/f5xc-api-enriched](https://github.com/robinmordasiewicz/f5xc-api-enriched/issues).
          labels: |
            automated
            upstream-sync
            chore
          reviewers: |
            robinmordasiewicz

      - name: Enable Auto-Merge
        if: steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Enabling auto-merge for PR #${{ steps.create-pr.outputs.pull-request-number }}"
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --auto \
            --squash \
            --delete-branch
          echo "âœ… Auto-merge enabled - PR will merge automatically when CI passes"

  # Step 3: Report if no updates
  no-updates:
    name: Report Status
    needs: check-upstream
    if: needs.check-upstream.outputs.has_updates == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Log status
        run: |
          echo "âœ“ No upstream updates available"
          echo "Current version: ${{ needs.check-upstream.outputs.current_version }}"
          echo "Latest version: ${{ needs.check-upstream.outputs.new_version }}"
