name: CI

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - "**.md"
      - "docs/**"
  pull_request:
    branches:
      - main
      - master
    paths-ignore:
      - "**.md"
      - "docs/**"

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npm run typecheck

      - name: Run ESLint
        run: npx eslint src/

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx}"

  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ["22"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22'
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  verify-generated:
    name: Verify Generated Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download enriched API specifications
        run: ./scripts/download-specs.sh

      - name: Regenerate domains
        run: npx tsx scripts/generate-domains.ts

      - name: Regenerate completions
        run: npx tsx scripts/generate-completions.ts

      - name: Validate generated files exist
        run: |
          echo "Validating generated files..."
          test -f src/types/domains_generated.ts || (echo "❌ domains_generated.ts missing" && exit 1)
          test -d completions || (echo "❌ completions/ directory missing" && exit 1)
          test -f completions/xcsh.bash || (echo "❌ xcsh.bash completion missing" && exit 1)
          test -f completions/_xcsh || (echo "❌ _xcsh zsh completion missing" && exit 1)
          test -f completions/xcsh.fish || (echo "❌ xcsh.fish completion missing" && exit 1)
          echo "✅ All generated files present"

      - name: Check for uncommitted domain changes
        run: |
          if ! git diff --quiet src/types/domains_generated.ts; then
            echo "::warning::Domain file differs from regenerated output"
            git diff src/types/domains_generated.ts | head -50
          else
            echo "✅ Domains are up to date."
          fi

      - name: Check for uncommitted completion changes
        run: |
          if ! git diff --quiet completions/; then
            echo "::warning::Completion files differ from regenerated output"
            git diff completions/ | head -50
          else
            echo "✅ Completions are up to date."
          fi

  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Ruff
        run: pip install ruff

      - name: Check Python formatting
        run: ruff format --check scripts/

      - name: Lint Python code
        run: ruff check scripts/ --output-format=github

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, lint-python, test, verify-generated]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download enriched API specifications
        run: ./scripts/download-specs.sh

      - name: Build package
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

      - name: Upload completion scripts
        uses: actions/upload-artifact@v4
        with:
          name: completions
          path: completions/
          retention-days: 7
